set -eux

echo "--- :docker: Setting up Docker-in-Docker"

docker network create "$BUILDKITE_PLUGIN_DIND_NETWORK_NAME" || true
docker run --privileged --name dind-daemon -d \
    --network "$BUILDKITE_PLUGIN_DIND_NETWORK_NAME" --network-alias docker \
    -e DOCKER_TLS_CERTDIR=/certs \
    -v docker-certs-ca:/certs/ca \
    -v "$BUILDKITE_PLUGIN_DIND_CERTS_VOLUME_NAME":/certs/client \
    -v "$BUILDKITE_PLUGIN_ADDITIONAL_VOLUME_MOUNT" \
    docker:dind || true
